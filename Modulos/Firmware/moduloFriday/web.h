#include <ESP8266WebServer.h>
#include "util.h"
#include "lampara.h"
#include "sensores.h"

ESP8266WebServer server(80);

 

//String web = "<!DOCTYPE HTML><html><head><title>Lampara</title></head><body><h1> <FONT SIZE=\"5\" COLOR=\"red\"> Colores </h1>Selecciona un color: <form action=\"\"><input name=\"color\" type=\"color\" style='width:300px; height:300px'/><input name=\"intensidad\" type=\"range\" style='width:80%; height:300px'/><br><input type=\"submit\" value=\"Cambiar\" style='width:100px; height:50px'/></form></body></html>";
//const String weblectura ="<!doctype html><html><head><meta charset='utf-8'/><meta name=description content='Resumen del contenido de la página'><title>Control del NodeMCU</title><style type=text/css>h2{text-shadow:1px 2px #999;font-size:30px}header{background:#097293;padding:20px;border-top-left-radius:35px;border-top-right-radius:15px;text-align:center;color:#eee}nav{margin:2% auto 2% 40%}nav a{text-decoration:none;padding-right:40px;color:black}nav a:visited{color:black}section{width:80%;margin:8% auto;background-color:white;padding:8px;border-right:black 1px solid;border-left:black 1px solid;border-top-left-radius:20px;border-top-right-radius:20px;border-bottom-right-radius:20px;border-bottom-left-radius:20px}article{background-color:whitesmoke;padding:5px}span{font-size:9px}label{display:block;margin-top:10px}button{margin-top:5px}form{padding:2% 40%;background-color:beige;border:red solid;border-bottom-right-radius:190px}footer{background-color:#097293;margin-top:5px;text-align:center;border-bottom-left-radius:35px;border-bottom-right-radius:15px;color:white;padding:5px}aside{display:block;width:15%;border:solid 2px black;padding:40px;border-bottom-left-radius:30px;border-bottom-right-radius:30px;border-top-left-radius:30px;border-top-right-radius:30px}.muestrario{display:block;float:right;margin-right:30%;margin-top:5%}.progressbar{-moz-orient:vertical}label{background-color:green;padding:10px;border:2px black solid;color:white}</style></head><body><header><h1>Control de NodeMCU</h1></header><nav><a href=/>Inicio</a><a href=/lecturas>Lecturas</a><a href=/control>Control</a><a href=/about>Sobre el autor</a></nav><section id=contenido><center><h2>Lecturas</h2></center><article><h3>Esta es la web de control de mi NodeMCU</h3><span>Curso basico ESP8266 de <a href=http://www.sindormir.net>sindormir.net</a></span><p>Información de los sensores conectados a mi NodeMCU.</p><article class=muestrario><label for=male>Pin 1</label><label for=male>Pin 2</label><label for=male>Pin 3</label><label for=male>Pin 4</label></article><aside><p>Temperatura:</p><center><progress value=6 max=10 class=progressbar></progress></center></aside></article></section><footer>David Martín curso NodeMCU para <a href=http://www.sindormir.net>sindormir.net</a></footer></body></html>";
//String weblecturas ="<!doctype html> <html> <head> <meta charset='utf-8'/> <meta name=description content='Resumen del contenido de la página'> <title>Control del NodeMCU</title> <style type=text/css>h2{text-shadow:1px 2px #999;font-size:30px}header{background:#097293;padding:20px;border-top-left-radius:35px;border-top-right-radius:15px;text-align:center;color:#eee}nav{margin:2% auto 2% 40%}nav a{text-decoration:none;padding-right:40px;color:black}nav a:visited{color:black}section{width:80%;margin:8% auto;background-color:white;padding:8px;border-right:black 1px solid;border-left:black 1px solid;border-top-left-radius:20px;border-top-right-radius:20px;border-bottom-right-radius:20px;border-bottom-left-radius:20px}article{background-color:whitesmoke;padding:5px}span{font-size:9px}label{display:block;margin-top:10px}button{margin-top:5px}form{padding:2% 40%;background-color:beige;border:red solid;border-bottom-right-radius:190px}footer{background-color:#097293;margin-top:5px;text-align:center;border-bottom-left-radius:35px;border-bottom-right-radius:15px;color:white;padding:5px}aside{display:block;width:15%;border:solid 2px black;padding:40px;border-bottom-left-radius:30px;border-bottom-right-radius:30px;border-top-left-radius:30px;border-top-right-radius:30px}.muestrario{display:block;float:right;margin-right:30%;margin-top:5%}.progressbar{-moz-orient:vertical;display:inline}label{background-color:green;padding:10px;border:2px black solid;color:white}.container{width:400px;height:200px;position:relative;top:30%;left:50%;overflow:hidden;text-align:center;transform:translate(-50%,-50%)}.GaugeMeter{position:Relative;text-align:Center;overflow:Hidden;cursor:Default;display:inline-block}.GaugeMeter SPAN,.GaugeMeter B{width:54%;position:Absolute;text-align:Center;display:Inline-Block;color:RGBa(0,0,0,.8);font-weight:100;font-family:'Open Sans',Arial;overflow:Hidden;white-space:NoWrap;text-overflow:Ellipsis;margin:0 23%}.GaugeMeter[data-style='Semi'] B{width:80%;margin:0 10%}.GaugeMeter S,.GaugeMeter U{text-decoration:None;font-size:.60em;font-weight:200;opacity:.6}.GaugeMeter B{color:#000;font-weight:200;opacity:.8}.representaciones{padding-left:30%;padding-top:10%;padding-bottom:30%}</style> </head> <body> <header> <h1>Control de NodeMCU</h1> </header> <nav> <a href>Inicio</a> <a href=/lecturas>Lecturas</a> <a href=/control>Control</a> <a href=/about>Sobre el autor</a> </nav> <section id=contenido> <center><h2>Lecturas</h2></center> <article> <h3>Esta es la web de control de mi NodeMCU</h3> <span>Curso basico ESP8266 de <a href=http://www.sindormir.net>sindormir.net</a></span> <p>Información de los sensores conectados a mi NodeMCU.</p> <div class=representaciones> <div class=GaugeMeter id=PreviewGaugeMeter_3 data-percent=\""+readTemperaturaStr()+"\" data-text=\"<font style='color:Black;font-size:35px;letter-spacing:-1px'>"+readTemperaturaStr()+"</font>\" data-append=\"<font style='color:black'>º</font>\" data-size=200 data-theme=Red data-back=RGBa(0,0,0,.1) data-width=15 data-label=Temperatura data-style=Semi data-label_color=#000></div> <div class=GaugeMeter id=PreviewGaugeMeter_4 data-percent="+readHumedadStr()+" data-append=% data-size=180 data-theme=Blue data-back=RGBa(0,0,0,.1) data-animate_gauge_colors=1 data-animate_text_colors=1 data-width=15 data-label=Humedad data-label_color=#000 data-stripe=2></div> </div> </article> <script src=http://code.jquery.com/jquery-2.1.4.min.js></script> <script src=http://www.jqueryscript.net/demo/Customizable-Animated-jQuery-HTML5-Gauge-Meter-Plugin/jquery.AshAlom.gaugeMeter-2.0.0.min.js></script> <script>$('.GaugeMeter').gaugeMeter();</script> <script type=text/javascript>var _gaq=_gaq||[];_gaq.push(['_setAccount','UA-36251023-1']);_gaq.push(['_setDomainName','jqueryscript.net']);_gaq.push(['_trackPageview']);(function(){var b=document.createElement('script');b.type='text/javascript';b.async=true;b.src=('https:'==document.location.protocol?'https://ssl':'http://www')+'.google-analytics.com/ga.js';var a=document.getElementsByTagName('script')[0];a.parentNode.insertBefore(b,a)})();</script> </section> <footer>David Martín curso NodeMCU para <a href=http://www.sindormir.net>sindormir.net</a></footer> </body> </html>";

//Index del sistema web del NodeMCU
void bienvenida(){
  const String webprincipal ="<!doctype html><html><head><meta charset='utf-8'/><meta name=description content='Resumen del contenido de la página'><title>Control del NodeMCU</title><style type=text/css>h2{text-shadow:1px 2px #999;font-size:30px}header{background:#097293;padding:20px;border-top-left-radius:35px;border-top-right-radius:15px;text-align:center;color:#eee}nav{margin:2% auto 2% 40%}nav a{text-decoration:none;padding-right:40px;color:black}nav a:visited{color:black}section{width:80%;margin:8% auto;background-color:white;padding:8px;border-right:black 1px solid;border-left:black 1px solid;border-top-left-radius:20px;border-top-right-radius:20px;border-bottom-right-radius:20px;border-bottom-left-radius:20px}article{background-color:whitesmoke;padding:5px}span{font-size:9px}label{display:block;margin-top:10px}button{margin-top:5px}form{padding:2% 40%;background-color:beige;border:red solid;border-bottom-right-radius:190px}footer{background-color:#097293;margin-top:5px;text-align:center;border-bottom-left-radius:35px;border-bottom-right-radius:15px;color:white;padding:5px}</style></head><body><header><h1>Control de NodeMCU</h1></header><nav><a href=/>Inicio</a><a href=/lecturas>Lecturas</a><a href=/control>Control</a><a href=/about>Sobre el autor</a></nav><section id=contenido><center><h2>Bienvenido</h2></center><article><h3>Esta es la web de control de mi NodeMCU</h3><span>Curso basico ESP8266 de <a href=http://www.sindormir.net>sindormir.net</a></span><p>Esta web contiene todo lo necesario para monitorizar y controlar el funcionamiento de los elementos conectados a mi NodeMCU.</p><p>Los NodeMCU pueden ser muy adictivos, usense con responsabilidad. El SAV es poderoso en ellos.</p><center><img src=https://sindormir.net/sites/sindormir.net/files/cursos/curso-nodemcu-basico-texto-dch.png.jpg width=70%></center></article></section><footer>David Martín curso NodeMCU para <a href=http://www.sindormir.net>sindormir.net</a></footer></body></html>";
  server.send(200, "html",webprincipal);
//    Serial.print(humedad);
}

//Toma de datos desde el NodeMCU
void lecturas(){
  String weblecturas ="<!doctype html> <html> <head> <meta charset='utf-8'/> <meta name=description content='Resumen del contenido de la página'> <title>Control del NodeMCU</title> <style type=text/css>h2{text-shadow:1px 2px #999;font-size:30px}header{background:#097293;padding:20px;border-top-left-radius:35px;border-top-right-radius:15px;text-align:center;color:#eee}nav{margin:2% auto 2% 40%}nav a{text-decoration:none;padding-right:40px;color:black}nav a:visited{color:black}section{width:80%;margin:8% auto;background-color:white;padding:8px;border-right:black 1px solid;border-left:black 1px solid;border-top-left-radius:20px;border-top-right-radius:20px;border-bottom-right-radius:20px;border-bottom-left-radius:20px}article{background-color:whitesmoke;padding:5px}span{font-size:9px}label{display:block;margin-top:10px}button{margin-top:5px}form{padding:2% 40%;background-color:beige;border:red solid;border-bottom-right-radius:190px}footer{background-color:#097293;margin-top:5px;text-align:center;border-bottom-left-radius:35px;border-bottom-right-radius:15px;color:white;padding:5px}aside{display:block;width:15%;border:solid 2px black;padding:40px;border-bottom-left-radius:30px;border-bottom-right-radius:30px;border-top-left-radius:30px;border-top-right-radius:30px}.muestrario{display:block;float:right;margin-right:30%;margin-top:5%}.progressbar{-moz-orient:vertical;display:inline}label{background-color:green;padding:10px;border:2px black solid;color:white}.container{width:400px;height:200px;position:relative;top:30%;left:50%;overflow:hidden;text-align:center;transform:translate(-50%,-50%)}.GaugeMeter{position:Relative;text-align:Center;overflow:Hidden;cursor:Default;display:inline-block}.GaugeMeter SPAN,.GaugeMeter B{width:54%;position:Absolute;text-align:Center;display:Inline-Block;color:RGBa(0,0,0,.8);font-weight:100;font-family:'Open Sans',Arial;overflow:Hidden;white-space:NoWrap;text-overflow:Ellipsis;margin:0 23%}.GaugeMeter[data-style='Semi'] B{width:80%;margin:0 10%}.GaugeMeter S,.GaugeMeter U{text-decoration:None;font-size:.60em;font-weight:200;opacity:.6}.GaugeMeter B{color:#000;font-weight:200;opacity:.8}.representaciones{padding-left:30%;padding-top:10%;padding-bottom:30%}</style> </head> <body> <header> <h1>Control de NodeMCU</h1> </header> <nav> <a href>Inicio</a> <a href=/lecturas>Lecturas</a> <a href=/control>Control</a> <a href=/about>Sobre el autor</a> </nav> <section id=contenido> <center><h2>Lecturas</h2></center> <article> <h3>Esta es la web de control de mi NodeMCU</h3> <span>Curso basico ESP8266 de <a href=http://www.sindormir.net>sindormir.net</a></span> <p>Información de los sensores conectados a mi NodeMCU.</p> <div class=representaciones> <div class=GaugeMeter id=PreviewGaugeMeter_3 data-percent=\""+readTemperaturaStr()+"\" data-text=\"<font style='color:Black;font-size:35px;letter-spacing:-1px'>"+readTemperaturaStr()+"</font>\" data-append=\"<font style='color:black'>º</font>\" data-size=200 data-theme=Red data-back=RGBa(0,0,0,.1) data-width=15 data-label=Temperatura data-style=Semi data-label_color=#000></div> <div class=GaugeMeter id=PreviewGaugeMeter_4 data-percent="+readHumedadStr()+" data-append=% data-size=180 data-theme=Blue data-back=RGBa(0,0,0,.1) data-animate_gauge_colors=1 data-animate_text_colors=1 data-width=15 data-label=Humedad data-label_color=#000 data-stripe=2></div> </div> </article> <script src=http://code.jquery.com/jquery-2.1.4.min.js></script> <script src=http://www.jqueryscript.net/demo/Customizable-Animated-jQuery-HTML5-Gauge-Meter-Plugin/jquery.AshAlom.gaugeMeter-2.0.0.min.js></script> <script>$('.GaugeMeter').gaugeMeter();</script> <script type=text/javascript>var _gaq=_gaq||[];_gaq.push(['_setAccount','UA-36251023-1']);_gaq.push(['_setDomainName','jqueryscript.net']);_gaq.push(['_trackPageview']);(function(){var b=document.createElement('script');b.type='text/javascript';b.async=true;b.src=('https:'==document.location.protocol?'https://ssl':'http://www')+'.google-analytics.com/ga.js';var a=document.getElementsByTagName('script')[0];a.parentNode.insertBefore(b,a)})();</script> </section> <footer>David Martín curso NodeMCU para <a href=http://www.sindormir.net>sindormir.net</a></footer> </body> </html>";
  server.send(200, "html",weblecturas);
}


void control() {
  const String webcontrol ="<!doctype html> <html> <head><meta charset='utf-8'/><title>Control del NodeMCU</title> <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js'></script><script src=https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js></script> <script src=http://www.jqueryscript.net/demo/Circular-Slider-Plugin-With-jQuery-D3-js-Wheel/js/jquery.wheel.js></script> <style type=text/css>h2{text-shadow:1px 2px #999;font-size:30px}header{background:#097293;padding:20px;border-top-left-radius:35px;border-top-right-radius:15px;text-align:center;color:#eee}nav{margin:2% auto 2% 40%}nav a{text-decoration:none;padding-right:40px;color:black}nav a:visited{color:black}section{width:80%;margin:8% auto;background-color:white;padding:8px;border-right:black 1px solid;border-left:black 1px solid;border-top-left-radius:20px;border-top-right-radius:20px;border-bottom-right-radius:20px;border-bottom-left-radius:20px}article{background-color:whitesmoke;padding:5px}span{font-size:9px}label{display:block;margin-top:10px}button{margin-top:5px}form{padding:2% 40%}footer{background-color:#097293;margin-top:5px;text-align:center;border-bottom-left-radius:35px;border-bottom-right-radius:15px;color:white;padding:5px}.botonera{margin-bottom:30px;margin-top:20px;width:100%}.wheel{width:200px;height:200px;border-radius:100px;background-color:lightgray;position:relative}.wheel .wheel-handle{-webkit-tap-highlight-color:transparent;background-color:dodgerblue;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,0.5);height:20px;left:50%;margin:-10px 0 0 -10px;outline:0;position:absolute;top:10px;width:20px}.wheel .wheel-center{text-align:center;white-space:nowrap;background-color:white;border-radius:80px;box-shadow:0 2px 4px rgba(0,0,0,0.5);height:160px;left:20px;position:relative;top:20px;width:160px}.wheel .wheel-center:before{content:'';display:inline-block;height:100%;vertical-align:middle;margin-right:-0.25em}.wheel .wheel-center>*{display:inline-block;vertical-align:middle}.wheel .wheel-progress{height:100%;left:0;position:absolute;top:0;width:100%}.wheel .wheel-progress:after{border-radius:100px;box-shadow:0 2px 4px rgba(0,0,0,0.5) inset;content:'';display:block;height:100%;left:0;position:absolute;top:0;width:100%}.wheel .wheel-progress-fill{fill:#9dcfff}.btn{background:#3498db;background-image:-webkit-linear-gradient(top,#3498db,#2980b9);background-image:-moz-linear-gradient(top,#3498db,#2980b9);background-image:-ms-linear-gradient(top,#3498db,#2980b9);background-image:-o-linear-gradient(top,#3498db,#2980b9);background-image:linear-gradient(to bottom,#3498db,#2980b9);-webkit-border-radius:38;-moz-border-radius:38;border-radius:38px;text-shadow:8px 1px 3px #666;font-family:Georgia;color:#fff;font-size:24px;padding:10px 20px 10px 20px;border:solid #1f628d 2px;text-decoration:none}.btn:hover{background:#3cb0fd;background-image:-webkit-linear-gradient(top,#3cb0fd,#3498db);background-image:-moz-linear-gradient(top,#3cb0fd,#3498db);background-image:-ms-linear-gradient(top,#3cb0fd,#3498db);background-image:-o-linear-gradient(top,#3cb0fd,#3498db);background-image:linear-gradient(to bottom,#3cb0fd,#3498db);text-decoration:none}</style> </head> <body> <header> <h1>Control de NodeMCU</h1> </header> <nav> <a href=/>Inicio</a> <a href=/lecturas>Lecturas</a> <a href=/control>Control</a> <a href=/about>Sobre el autor</a> </nav> <section id=contenido> <center><h2>Control</h2></center> <article> <h3>Esta es la web de control de mi NodeMCU</h3> <span>Curso basico ESP8266 de <a href=http://www.sindormir.net>sindormir.net</a></span> <form class action method=get id=datos name=datos> <div class=botonera> <input type=submit name=led value=1 class=btn> <input type=submit name=led value=2 class=btn> <input type=submit name=led value=3 class=btn></div <div class=centered> <div class=wheel> <div class=wheel-progress></div> <div class=wheel-center> <span class=wheel-value></span> </div> <a href=javascript:void(0) class=wheel-handle></a> </div> </div> <script>$(function(){$(\".wheel\").wheel({min:0,max:180,onChange:function(a){$(\".wheel-value\").html(Math.round(a)+\"&deg;\");document.datos.intensidad.value=Math.round(a)}})});</script> <div class=botonera> <input type=hidden name=intensidad> <center><input type=color name=color/><input type=submit value=Enviar class=btn></center> </div> </form> </article> </section> <footer>David Martín curso NodeMCU para <a href=http://www.sindormir.net>sindormir.net</a></footer> </body> </html>";
  String colores;
  server.method() == HTTP_GET;
  server.send(200, "html", webcontrol);
  Serial.print("Argumentos:");
  Serial.println(server.args());
  Serial.print("URI:");
  Serial.println(server.uri());
  for (uint8_t i=0; i<server.args(); i++){
    colores += " " + server.argName(i) + ": " + server.arg(i) + "\n";
  }
  Serial.println(colores);
  
  //Busca el comienzo del codigo hexadecimal de color
  int firstHastag = colores.indexOf('#');
  Serial.print("Primera respuesta: ");Serial.println(firstHastag);
  
  //Extrae los colores codificados en Hexadecimal en R-G-B
  R = colores.substring(firstHastag+1, firstHastag+3);
  G = colores.substring(firstHastag+3, firstHastag+5);
  B = colores.substring(firstHastag+5, firstHastag+7);
  Serial.print("Color en Hex: ");Serial.print(R);Serial.print("-"); Serial.print(G);Serial.print("-");Serial.println(B);
  
  //Convierte los valores de color hexadecimales en decimales
  R = hexToDec(R);
  G = hexToDec(G);
  B = hexToDec(B);  
  Serial.print("Color en RGB: ");Serial.print(R);Serial.print("-"); Serial.print(G);Serial.print("-");Serial.println(B);
  
  //Transforma el String en valores integer
  Ri = R.toInt();
  Gi = G.toInt();
  Bi = B.toInt();

  //Obtenemos la intensidad
  int findIntensidad = colores.indexOf('intensidad');
  int ultPos = colores.length();
  //int ultPos = colores.lastIndexOf('/');
  Serial.print("Comienza la cadena");Serial.println(findIntensidad);Serial.print("Posicion");Serial.println(ultPos);
  intensidad = colores.substring(findIntensidad+4,ultPos-1);
  Ii = intensidad.toInt();
  Serial.print("Intensidad: ");Serial.println(intensidad);
  Serial.print("I: ");Serial.println(Ii);
  
  //mapeamos los valores del range HTML5 (0 a 100) a brightness de Neopixel (0 a 255)
  Ii = map(Ii, 0, 100, 0, 255);
  Serial.print("Intensidad mapeada: ");Serial.println(Ii);
  
  //Encendemos la luces en el color seleccionado
  iluminacion(Ri,Gi,Bi,Ii);
 
}

//Pagina sobre el proyecto y el autor
void about(){
  const String webabout  ="<!doctype html> <html> <head> <meta charset='utf-8'/> <meta name=description content='Resumen del contenido de la página'> <title>Control del NodeMCU</title> <style type=text/css>h2{text-shadow:1px 2px #999;font-size:30px}header{background:#097293;padding:20px;border-top-left-radius:35px;border-top-right-radius:15px;text-align:center;color:#eee}nav{margin:2% auto 2% 40%}nav a{text-decoration:none;padding-right:40px;color:black}nav a:visited{color:black}section{width:80%;margin:8% auto;background-color:white;padding:8px;border-right:black 1px solid;border-left:black 1px solid;border-top-left-radius:20px;border-top-right-radius:20px;border-bottom-right-radius:20px;border-bottom-left-radius:20px}article{background-color:whitesmoke;padding:5px}span{font-size:9px}label{display:block;margin-top:10px}button{margin-top:5px}form{padding:2% 40%;background-color:beige;border:red solid;border-bottom-right-radius:190px}footer{background-color:#097293;margin-top:5px;text-align:center;border-bottom-left-radius:35px;border-bottom-right-radius:15px;color:white;padding:5px}img{border-bottom-left-radius:170px;border-bottom-right-radius:170px;border-top-left-radius:170px;border-top-right-radius:170px}</style> </head> <body> <header> <h1>Control de NodeMCU</h1> </header> <nav> <a href=/>Inicio</a> <a href=/lecturas>Lecturas</a> <a href=/control>Control</a> <a href=/about>Sobre el autor</a> </nav> <section id=contenido> <center><h2>Sobre el autor</h2></center> <article> <h3>Un poco sobre mi</h3> <span>Curso basico ESP8266 de <a href=http://www.sindormir.net>sindormir.net</a></span> <p>Los gemelos de Mammon lucharon. Su pelea sumió el mundo en una nueva oscuridad y la bestia detestaba la oscuridad. Así que comenzó a moverse audazmente y se hizo más poderosa y fue más allá y se multiplicó. Y las bestias trajeron fuego y luz a la oscuridad..</p> <span>El libro de Mozilla, 15:1</span> <center><img src=http://www.crakernano.com/images/me.JPG width=20%></center> </article> </section> <footer>David Martín curso NodeMCU para <a href=http://www.sindormir.net>sindormir.net</a></footer> </body> </html>";
  server.send(200, "html",webabout);
}

void handleNotFound(){

  String message = "File Not Found\n\n";
  message += "URI: ";
  message += server.uri();
  message += "\nMethod: ";
  message += (server.method() == HTTP_GET)?"GET":"POST";
  message += "\nArguments: ";
  message += server.args();
  message += "\n";
  for (uint8_t i=0; i<server.args(); i++){
    message += " " + server.argName(i) + ": " + server.arg(i) + "\n";
  }
  server.send(404, "text/plain", message);

}
